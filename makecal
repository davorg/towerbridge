#!/usr/bin/perl

use strict;
use warnings;
use 5.010;

use Data::Dumper;
use Time::Piece;
use Web::Query;
use Date::ICal;
use Data::ICal;
use Data::ICal::Entry::Event;

my $this_year = (localtime)[5] + 1900;

my $ical = Data::ICal->new();
my $fmt = '%H:%M %d %b %Y';

my @lifts;

wq('http://www.towerbridge.org.uk/lift-times/')
  ->find('table.lined tbody tr')
  ->each(sub { push @lifts, [ map { $_->text } $_[1]->contents ] });

foreach (@lifts) {
  say "$_->[2] $_->[1] $this_year";
  my $date = Time::Piece->strptime("$_->[2] $_->[1] $this_year", $fmt);
  my $event = Data::ICal::Entry::Event->new();
  $event->add_properties(
    summary => 'Tower Bridge Lift',
    description => "$_->[3] ($_->[4])",
    dtstart => Date::ICal->new(epoch => $date->epoch)->ical,
  );
  $ical->add_entry($event);
}

open my $ical_fh, '>', 'towerbridge.ics' or die $!;
print $ical_fh $ical->as_string;
